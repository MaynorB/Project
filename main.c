#include "stm32l432xx.h"
#include "STM32L432KC_SPI.h"
#include "SD_lowlevel.h"
#include "STM32L432KC_GPIO.h"
#include "ff.h"    // FatFS core
#include "diskio.h"
#include <string.h>

///////////////////////////////////////////////////////////////////////////////
// Debug LED setup
///////////////////////////////////////////////////////////////////////////////
#define LED_PIN PA5   // Change if needed for your board

///////////////////////////////////////////////////////////////////////////////
// Global FatFS variables
///////////////////////////////////////////////////////////////////////////////
FATFS FatFs;      // File system object
FIL file;         // File object
FRESULT fres;     // FatFS function common result code

///////////////////////////////////////////////////////////////////////////////
// Delay helper (simple software delay)
///////////////////////////////////////////////////////////////////////////////
static void delay_ms(uint32_t ms) {
    for (uint32_t i = 0; i < ms * 4000; i++) {
        __NOP();
    }
}

///////////////////////////////////////////////////////////////////////////////
// LED feedback helpers
///////////////////////////////////////////////////////////////////////////////
static void blink(uint8_t times) {
    for (uint8_t i = 0; i < times; i++) {
        digitalWrite(LED_PIN, 1);
        delay_ms(200);
        digitalWrite(LED_PIN, 0);
        delay_ms(200);
    }
}

static void led_on(void) {
    digitalWrite(LED_PIN, 1);
}

static void led_off(void) {
    digitalWrite(LED_PIN, 0);
}

///////////////////////////////////////////////////////////////////////////////
// MAIN
///////////////////////////////////////////////////////////////////////////////
int main(void) {
    // Basic setup
    SystemCoreClockUpdate();
    initSPI(0b111 , 0, 0); // Baud = fPCLK/8, mode 0 (CPOL=0, CPHA=0)
    pinMode(LED_PIN, GPIO_OUTPUT);
    led_off();

    ///////////////////////////////////////////////////////////////////////////
    // 1. Initialize SPI
    ///////////////////////////////////////////////////////////////////////////

    ///////////////////////////////////////////////////////////////////////////
    // 2. Initialize SD card (low-level)
    ///////////////////////////////////////////////////////////////////////////
    uint8_t sdStatus = SD_Init();
    if (sdStatus != SD_OK) {
        // ðŸ”´ Blink 3x = SD init failed
        blink(3);
        while (1);
    }

    ///////////////////////////////////////////////////////////////////////////
    // 3. Mount FAT filesystem
    ///////////////////////////////////////////////////////////////////////////
    fres = f_mount(&FatFs, "", 1);
    if (fres != FR_OK) {
        // ðŸ”´ Blink 4x = Mount failed
        blink(4);
        while (1);
    }

    ///////////////////////////////////////////////////////////////////////////
    // 4. Try to open .wav file
    ///////////////////////////////////////////////////////////////////////////
    fres = f_open(&file, "Crepe.wav", FA_READ);
    if (fres != FR_OK) {
        // ðŸ”´ Blink 5x = File not found
        blink(5);
        while (1);
    }

    ///////////////////////////////////////////////////////////////////////////
    // 5. Read a few bytes from the file header (e.g., to verify RIFF/WAVE)
    ///////////////////////////////////////////////////////////////////////////
    BYTE buffer[16];
    UINT bytesRead;

    fres = f_read(&file, buffer, sizeof(buffer), &bytesRead);
    if (fres != FR_OK || bytesRead == 0) {
        // ðŸ”´ Blink 6x = Read error
        blink(6);
        while (1);
    }

    // Check if file starts with "RIFF"
    if (memcmp(buffer, "RIFF", 4) == 0 && memcmp(&buffer[8], "WAVE", 4) == 0) {
        // âœ… File is a valid WAV file
        led_on();  // Solid ON = success
    } else {
        // âš ï¸ File not recognized
        blink(2);
    }

    ///////////////////////////////////////////////////////////////////////////
    // 6. Close file and stay idle
    ///////////////////////////////////////////////////////////////////////////
    f_close(&file);
    while (1);
}
